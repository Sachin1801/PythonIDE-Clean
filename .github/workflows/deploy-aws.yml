name: Deploy to AWS ECS (Main + Exam IDE)

on:
  push:
    branches: [ main ]
  workflow_dispatch: # Allow manual trigger

env:
  AWS_REGION: us-east-2
  ECR_REPOSITORY: pythonide-backend
  ECS_CLUSTER: pythonide-cluster
  # Main IDE service
  ECS_SERVICE_MAIN: pythonide-service
  # Exam IDE service
  ECS_SERVICE_EXAM: pythonide-exam-task-service
  ECS_TASK_DEFINITION: .github/ecs-task-definition.json

jobs:
  deploy:
    name: Deploy to Main + Exam IDE
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Build, tag, and push image to Amazon ECR
      id: build-image
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        # Build Docker image for linux/amd64 platform
        docker build --platform linux/amd64 -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
        docker build --platform linux/amd64 -t $ECR_REGISTRY/$ECR_REPOSITORY:latest .

        # Push both tags
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

        echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

    - name: Fill in the new image ID in the Amazon ECS task definition
      id: task-def
      uses: aws-actions/amazon-ecs-render-task-definition@v1
      with:
        task-definition: ${{ env.ECS_TASK_DEFINITION }}
        container-name: pythonide-backend
        image: ${{ steps.build-image.outputs.image }}

    # ==================== MAIN IDE DEPLOYMENT ====================
    - name: Deploy to Main IDE (pythonide-service)
      uses: aws-actions/amazon-ecs-deploy-task-definition@v1
      with:
        task-definition: ${{ steps.task-def.outputs.task-definition }}
        service: ${{ env.ECS_SERVICE_MAIN }}
        cluster: ${{ env.ECS_CLUSTER }}
        wait-for-service-stability: true

    - name: Ensure Auto-Scaling Configuration (Main IDE)
      run: |
        echo "üéØ Verifying auto-scaling for Main IDE..."

        # Check if auto-scaling target exists
        SCALING_TARGET=$(aws application-autoscaling describe-scalable-targets \
          --service-namespace ecs \
          --resource-ids "service/${{ env.ECS_CLUSTER }}/${{ env.ECS_SERVICE_MAIN }}" \
          --region ${{ env.AWS_REGION }} \
          --query 'ScalableTargets[0].ResourceId' \
          --output text 2>/dev/null) || SCALING_TARGET="None"

        if [ "$SCALING_TARGET" = "None" ] || [ "$SCALING_TARGET" = "" ]; then
          echo "‚ö†Ô∏è Auto-scaling not configured for Main IDE. Setting up now..."

          # Register scalable target
          aws application-autoscaling register-scalable-target \
            --service-namespace ecs \
            --resource-id "service/${{ env.ECS_CLUSTER }}/${{ env.ECS_SERVICE_MAIN }}" \
            --scalable-dimension ecs:service:DesiredCount \
            --min-capacity 2 \
            --max-capacity 6 \
            --region ${{ env.AWS_REGION }}

          # Create scaling policy
          aws application-autoscaling put-scaling-policy \
            --policy-name "pythonide-main-cpu-scaling-policy" \
            --service-namespace ecs \
            --resource-id "service/${{ env.ECS_CLUSTER }}/${{ env.ECS_SERVICE_MAIN }}" \
            --scalable-dimension ecs:service:DesiredCount \
            --policy-type TargetTrackingScaling \
            --target-tracking-scaling-policy-configuration '{
                "TargetValue": 45.0,
                "PredefinedMetricSpecification": {
                    "PredefinedMetricType": "ECSServiceAverageCPUUtilization"
                },
                "ScaleOutCooldown": 300,
                "ScaleInCooldown": 300
            }' \
            --region ${{ env.AWS_REGION }}

          echo "‚úÖ Main IDE auto-scaling configured"
        else
          echo "‚úÖ Main IDE auto-scaling already configured"
        fi

    # ==================== EXAM IDE DEPLOYMENT ====================
    - name: Deploy to Exam IDE (pythonide-exam-task-service)
      run: |
        echo "üéì Deploying to Exam IDE..."
        aws ecs update-service \
          --cluster ${{ env.ECS_CLUSTER }} \
          --service ${{ env.ECS_SERVICE_EXAM }} \
          --force-new-deployment \
          --region ${{ env.AWS_REGION }}

        echo "‚è≥ Waiting for Exam IDE deployment to stabilize..."
        aws ecs wait services-stable \
          --cluster ${{ env.ECS_CLUSTER }} \
          --services ${{ env.ECS_SERVICE_EXAM }} \
          --region ${{ env.AWS_REGION }}

        echo "‚úÖ Exam IDE deployment complete"

    - name: Ensure Auto-Scaling Configuration (Exam IDE)
      run: |
        echo "üéØ Verifying auto-scaling for Exam IDE..."

        # Check if auto-scaling target exists for exam IDE
        SCALING_TARGET=$(aws application-autoscaling describe-scalable-targets \
          --service-namespace ecs \
          --resource-ids "service/${{ env.ECS_CLUSTER }}/${{ env.ECS_SERVICE_EXAM }}" \
          --region ${{ env.AWS_REGION }} \
          --query 'ScalableTargets[0].ResourceId' \
          --output text 2>/dev/null) || SCALING_TARGET="None"

        if [ "$SCALING_TARGET" = "None" ] || [ "$SCALING_TARGET" = "" ]; then
          echo "‚ö†Ô∏è Auto-scaling not configured for Exam IDE. Setting up now..."

          # Register scalable target for exam IDE
          aws application-autoscaling register-scalable-target \
            --service-namespace ecs \
            --resource-id "service/${{ env.ECS_CLUSTER }}/${{ env.ECS_SERVICE_EXAM }}" \
            --scalable-dimension ecs:service:DesiredCount \
            --min-capacity 1 \
            --max-capacity 4 \
            --region ${{ env.AWS_REGION }}

          # Create scaling policy for exam IDE
          aws application-autoscaling put-scaling-policy \
            --policy-name "pythonide-exam-cpu-scaling-policy" \
            --service-namespace ecs \
            --resource-id "service/${{ env.ECS_CLUSTER }}/${{ env.ECS_SERVICE_EXAM }}" \
            --scalable-dimension ecs:service:DesiredCount \
            --policy-type TargetTrackingScaling \
            --target-tracking-scaling-policy-configuration '{
                "TargetValue": 45.0,
                "PredefinedMetricSpecification": {
                    "PredefinedMetricType": "ECSServiceAverageCPUUtilization"
                },
                "ScaleOutCooldown": 300,
                "ScaleInCooldown": 300
            }' \
            --region ${{ env.AWS_REGION }}

          echo "‚úÖ Exam IDE auto-scaling configured"
        else
          echo "‚úÖ Exam IDE auto-scaling already configured"
        fi

    # ==================== VERIFICATION ====================
    - name: Verify Both Deployments
      run: |
        echo "üîç Verifying deployments..."
        echo ""

        echo "üìä MAIN IDE Status:"
        aws ecs describe-services \
          --cluster ${{ env.ECS_CLUSTER }} \
          --services ${{ env.ECS_SERVICE_MAIN }} \
          --region ${{ env.AWS_REGION }} \
          --query 'services[0].{Service:serviceName,Status:status,Running:runningCount,Desired:desiredCount}' \
          --output table

        echo ""
        echo "üìä EXAM IDE Status:"
        aws ecs describe-services \
          --cluster ${{ env.ECS_CLUSTER }} \
          --services ${{ env.ECS_SERVICE_EXAM }} \
          --region ${{ env.AWS_REGION }} \
          --query 'services[0].{Service:serviceName,Status:status,Running:runningCount,Desired:desiredCount}' \
          --output table

    - name: Post-Deployment Summary
      run: |
        echo ""
        echo "üéâ DEPLOYMENT SUMMARY"
        echo "====================="
        echo "‚úÖ Docker image built and pushed to ECR"
        echo "‚úÖ Main IDE (pythonide-service) deployed"
        echo "‚úÖ Exam IDE (pythonide-exam-task-service) deployed"
        echo "‚úÖ Auto-scaling verified for both services"
        echo ""
        echo "üîó Services:"
        echo "  ‚Ä¢ Main IDE: http://pythonide-classroom.tech/editor"
        echo "  ‚Ä¢ Exam IDE: http://exam.pythonide-classroom.tech/editor"
        echo ""
        echo "üìà Both services now running the same codebase (commit: ${{ github.sha }})"
